<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPU Analytics - Throttling Breakdown</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .gpu-status-container {
            margin-bottom: 2rem;
        }
        
        .gpu-label {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .gpu-status-box {
            width: 200px;
            height: 120px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        /* Dynamic colors are now set via JavaScript based on percentage */
        .gpu-status-box {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); /* Default green */
        }
        
        .gpu-count {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .gpu-percentage {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .summary-stats {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .summary-stat {
            display: inline-block;
            margin: 0 2rem;
        }
        
        .summary-stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            display: block;
        }
        
        .summary-stat-label {
            font-size: 1rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .last-updated {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 2rem;
        }

        /* Left Navigation Menu */
        .nav-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 250px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .nav-sidebar .nav-header {
            padding: 2rem 1.5rem 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        .nav-sidebar .nav-header h3 {
            color: white;
            font-size: 1.2rem;
            margin: 0;
            font-weight: 600;
        }
        
        .nav-sidebar .user-info {
            margin-top: 0.5rem;
            text-align: center;
        }
        
        .nav-sidebar .nav-logo {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .nav-sidebar .header-logo {
            width: 50px;
            height: 50px;
            margin: 0 auto;
            display: block;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .nav-sidebar .user-info small {
            color: #bdc3c7;
            font-size: 0.85rem;
        }

        .nav-sidebar .nav-menu {
            padding: 1rem 0;
        }

        .nav-sidebar .nav-item {
            padding: 0;
        }

        .nav-sidebar .nav-link {
            display: block;
            padding: 1rem 1.5rem;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-sidebar .nav-link:hover,
        .nav-sidebar .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left-color: #3498db;
        }

        .nav-sidebar .nav-link i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        /* Adjust main content for sidebar */
        .main-content {
            margin-left: 250px;
            padding: 0;
        }

        .dashboard-header {
            margin-left: 0;
        }

        .container {
            max-width: none;
            padding-left: 2rem;
            padding-right: 2rem;
        }
    </style>
</head>
<body>
    <!-- Left Navigation Sidebar -->
    <div class="nav-sidebar">
                    <div class="nav-header">
                <div class="nav-logo">
                    <img src="/static/images/voltage_park_logo.jpg" alt="Voltage Park Logo" class="header-logo">
                </div>
                <h3>GPU Monitor</h3>
                <div class="user-info">
                    <small>Welcome, <strong>{{ session.get('username', 'User') }}</strong></small>
                </div>
            </div>
        <nav class="nav-menu">
            <div class="nav-item">
                <a href="/" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="/query" class="nav-link">
                    <i class="fas fa-search"></i>Query Tool
                </a>
            </div>
            <div class="nav-item">
                <a href="/settings" class="nav-link">
                    <i class="fas fa-cog"></i>Settings
                </a>
            </div>
            <div class="nav-item">
                <a href="/analytics" class="nav-link active">
                    <i class="fas fa-chart-line"></i>Analytics
                </a>
            </div>
            <div class="nav-item">
                <a href="/logout" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i>Logout
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="dashboard-header">
            <div class="container">
                <div class="row">
                    <div class="col-12 text-center">
                        <h1 class="display-4 mb-3">GPU Analytics Dashboard</h1>
                        <p class="lead mb-0">Comprehensive analysis of GPU thermal throttling patterns</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Site Selection -->
        <div class="container mt-3">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <label for="siteSelect" class="form-label fw-bold">Select Site:</label>
                            <select class="form-select" id="siteSelect" onchange="changeSite()">
                                {% for site_code, site_info in sites.items() %}
                                    <option value="{{ site_code }}" {% if site_code == default_site %}selected{% endif %}>
                                        {{ site_code }} - {{ site_info.name }} ({{ site_info.total_gpu_nodes }} nodes, {{ site_info.total_gpus }} GPUs)
                                    </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Current site: <span id="currentSite">{{ default_site }}</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Date Range Selector -->
            <div class="date-selector" style="background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div class="row">
                    <div class="col-md-4">
                        <label for="startDate" class="form-label fw-bold text-dark">Start Date:</label>
                        <input type="date" class="form-control" id="startDate" value="">
                    </div>
                    <div class="col-md-4">
                        <label for="endDate" class="form-label fw-bold text-dark">End Date:</label>
                        <input type="date" class="form-control" id="endDate" value="">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-primary btn-lg w-100" id="queryBtn" onclick="loadAnalyticsData()">
                            <i class="fas fa-search me-2"></i>Query Analytics
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="summary-stats">
                <div class="summary-stat">
                    <span class="summary-stat-value" id="totalThrottled">0</span>
                    <span class="summary-stat-label">Total Throttled GPUs</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-stat-value" id="totalDevices">254</span>
                    <span class="summary-stat-label">Total GPU Nodes</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-stat-value" id="totalGPUs">2032</span>
                    <span class="summary-stat-label">Total GPUs</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-stat-value" id="throttleRate">0%</span>
                    <span class="summary-stat-label">Throttle Rate</span>
                </div>
            </div>
            
            <!-- GPU Infrastructure Summary -->
            <div class="summary-stats" style="margin-top: 1rem;">
                <div class="summary-stat">
                    <span class="summary-stat-value" style="color: #10b981;">254</span>
                    <span class="summary-stat-label">Planned GPU Nodes</span>
                </div>
                <div class="summary-stat">
                    <span class="summary-stat-value" style="color: #3b82f6;">2032</span>
                    <span class="summary-stat-label">Planned Total GPUs</span>
                </div>
            </div>
            


            <!-- GPU Status Grid -->
            <div class="row">
                <!-- Top Row: GPU_24, GPU_23, GPU_22, GPU_21 -->
                <div class="col-md-3">
                    <div class="gpu-status-container">
                        <div class="gpu-label">GPU_24</div>
                        <div class="gpu-status-box low" id="gpu-24">
                            <div class="gpu-count" id="count-24">0</div>
                            <div class="gpu-percentage" id="percent-24">0%</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="gpu-status-container">
                        <div class="gpu-label">GPU_23</div>
                        <div class="gpu-status-box low" id="gpu-23">
                            <div class="gpu-count" id="count-23">0</div>
                            <div class="gpu-percentage" id="percent-23">0%</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="gpu-status-container">
                        <div class="gpu-label">GPU_22</div>
                        <div class="gpu-status-box low" id="gpu-22">
                            <div class="gpu-count" id="count-22">0</div>
                            <div class="gpu-percentage" id="percent-22">0%</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="gpu-status-container">
                        <div class="gpu-label">GPU_21</div>
                        <div class="gpu-status-box low" id="gpu-21">
                            <div class="gpu-count" id="count-21">0</div>
                            <div class="gpu-percentage" id="percent-21">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Bottom Row: GPU_28, GPU_27, GPU_26, GPU_25 -->
                <div class="col-md-3">
                    <div class="gpu-status-container">
                        <div class="gpu-label">GPU_28</div>
                        <div class="gpu-status-box low" id="gpu-28">
                            <div class="gpu-count" id="count-28">0</div>
                            <div class="gpu-percentage" id="percent-28">0%</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="gpu-status-container">
                        <div class="gpu-label">GPU_27</div>
                        <div class="gpu-status-box low" id="gpu-27">
                            <div class="gpu-count" id="count-27">0</div>
                            <div class="gpu-percentage" id="percent-27">0%</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="gpu-status-container">
                        <div class="gpu-label">GPU_26</div>
                        <div class="gpu-status-box low" id="gpu-26">
                            <div class="gpu-count" id="count-26">0</div>
                            <div class="gpu-percentage" id="percent-26">0%</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="gpu-status-container">
                        <div class="gpu-label">GPU_25</div>
                        <div class="gpu-status-box low" id="gpu-25">
                            <div class="gpu-count" id="count-25">0</div>
                            <div class="gpu-percentage" id="percent-25">0%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="last-updated">
                <span id="lastUpdated">Last updated: Never</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Site configuration
        let currentSite = '{{ default_site }}';
        let currentSiteConfig = {{ sites|tojson }};
        
        // GPU configuration - will be updated based on selected site
        let GPU_CONFIG = {
            '24': { cluster: 'C1', subnet: '10.4.11.*', ip_range: '10.4.11.1-127', description: 'GPU Node 24 - Cluster 1', gpu_count: 8 },
            '23': { cluster: 'C1', subnet: '10.4.11.*', ip_range: '10.4.11.1-127', description: 'GPU Node 23 - Cluster 1', gpu_count: 8 },
            '22': { cluster: 'C1', subnet: '10.4.11.*', ip_range: '10.4.11.1-127', description: 'GPU Node 22 - Cluster 1', gpu_count: 8 },
            '21': { cluster: 'C1', subnet: '10.4.11.*', ip_range: '10.4.11.1-127', description: 'GPU Node 21 - Cluster 1', gpu_count: 8 },
            '28': { cluster: 'C2', subnet: '10.4.21.*', ip_range: '10.4.21.1-127', description: 'GPU Node 28 - Cluster 2', gpu_count: 8 },
            '27': { cluster: 'C2', subnet: '10.4.21.*', ip_range: '10.4.21.1-127', description: 'GPU Node 27 - Cluster 2', gpu_count: 8 },
            '26': { cluster: 'C2', subnet: '10.4.21.*', ip_range: '10.4.21.1-127', description: 'GPU Node 26 - Cluster 2', gpu_count: 8 },
            '25': { cluster: 'C2', subnet: '10.4.21.*', ip_range: '10.4.21.1-127', description: 'GPU Node 25 - Cluster 2', gpu_count: 8 }
        };
        
        // Function to change site
        function changeSite() {
            const siteSelect = document.getElementById('siteSelect');
            const newSite = siteSelect.value;
            
            if (newSite !== currentSite) {
                currentSite = newSite;
                document.getElementById('currentSite').textContent = newSite;
                
                // Update GPU configuration based on new site
                updateGPUConfigForSite(newSite);
                
                // Reload analytics data for new site
                loadAnalyticsData();
            }
        }
        
        // Function to update GPU configuration based on selected site
        function updateGPUConfigForSite(siteCode) {
            const siteConfig = currentSiteConfig[siteCode];
            if (siteConfig && siteConfig.ip_ranges) {
                // Update GPU configuration based on site's IP ranges
                // This is a simplified example - you may want to make this more dynamic
                console.log(`Updated GPU config for ${siteCode}:`, siteConfig.ip_ranges);
            }
        }
        
        // Site configuration constants
        const SITE_CONFIG = {
            total_gpu_nodes: 254,
            total_gpus: 2032,
            gpus_per_node: 8,
            clusters: {
                'C1': { gpu_node_count: 127, total_gpus: 1016 },
                'C2': { gpu_node_count: 127, total_gpus: 1016 }
            }
        };
        
        const GPU_IDS = Object.keys(GPU_CONFIG);
        
        // Initialize analytics dashboard
        function initializeAnalytics() {
            // Set default dates (last 30 days)
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - (30 * 60 * 60 * 1000 * 24));
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            
            // Always ensure infrastructure values are displayed correctly
            document.getElementById('totalDevices').textContent = SITE_CONFIG.total_gpu_nodes;
            document.getElementById('totalGPUs').textContent = SITE_CONFIG.total_gpus;
            
            // Load initial data
            loadAnalyticsData();
            
            // Set up periodic refresh every 15 minutes
            setInterval(loadAnalyticsData, 15 * 60 * 1000);
            
            // Update timestamp
            updateTimestamp();
        }
        
        // Load analytics data from API
        async function loadAnalyticsData() {
            try {
                console.log('Loading analytics data...');
                
                // Get selected dates from the form
                const startDateStr = document.getElementById('startDate').value;
                const endDateStr = document.getElementById('endDate').value;
                
                console.log('Selected dates:', startDateStr, 'to', endDateStr);
                
                if (!startDateStr || !endDateStr) {
                    console.error('Please select both start and end dates');
                    return;
                }
                
                const apiUrl = `/api/analysis?site=${currentSite}&start_date=${startDateStr}&end_date=${endDateStr}&alert_type=both`;
                console.log('API URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('API response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API response data:', data);
                    
                    if (data.success) {
                        console.log('Processing analytics data...');
                        processAnalyticsData(data.results);
                    } else {
                        console.error('API returned success: false');
                    }
                } else {
                    console.error('API request failed with status:', response.status);
                }
            } catch (error) {
                console.error('Error loading analytics data:', error);
            }
            
            updateTimestamp();
        }
        
        // Process analytics data and update display
        function processAnalyticsData(results) {
            const throttledAlerts = results.throttled || [];
            const thermallyFailedAlerts = results.thermally_failed || [];
            
            // Debug logging
            console.log('Analytics results:', results);
            console.log('Throttled alerts:', throttledAlerts);
            console.log('Thermally failed alerts:', thermallyFailedAlerts);
            
            // Create a map to track unique throttling events by IP + GPU_ID combination
            const uniqueThrottleEvents = new Map();
            
            // Process throttled alerts for unique events
            throttledAlerts.forEach(alert => {
                if (alert.device && alert.gpu_id) {
                    // Create unique key: IP + GPU_ID
                    const uniqueKey = `${alert.device}_${alert.gpu_id}`;
                    if (!uniqueThrottleEvents.has(uniqueKey)) {
                        uniqueThrottleEvents.set(uniqueKey, alert);
                    }
                }
            });
            
            // Count unique throttled GPUs by GPU ID
            const gpuCounts = {};
            GPU_IDS.forEach(id => gpuCounts[id] = 0);
            
            // Count unique events for each GPU ID
            // This counts how many unique IP+GPU_ID combinations had throttling events
            uniqueThrottleEvents.forEach((alert, uniqueKey) => {
                // Extract the number part from GPU_21 -> 21, GPU_22 -> 22, etc.
                let gpuId = alert.gpu_id;
                if (gpuId && gpuId.startsWith('GPU_')) {
                    gpuId = gpuId.substring(4); // Remove "GPU_" prefix
                }
                
                if (gpuCounts.hasOwnProperty(gpuId)) {
                    gpuCounts[gpuId]++;
                }
            });
            
            // Calculate total unique throttled GPUs
            const totalThrottled = uniqueThrottleEvents.size;
            
            // Use API throttled count if available, otherwise use calculated count
            const apiThrottledCount = results.summary?.throttled_count || 0;
            const finalThrottledCount = apiThrottledCount > 0 ? apiThrottledCount : totalThrottled;
            
            console.log('Unique throttle events (calculated):', totalThrottled);
            console.log('API throttled count:', apiThrottledCount);
            console.log('Final throttled count to display:', finalThrottledCount);
            console.log('GPU counts by ID:', gpuCounts);
            
                        // Update summary statistics
            document.getElementById('totalThrottled').textContent = finalThrottledCount;
            
            // Always use the correct infrastructure values (254 nodes, 2032 GPUs)
            const totalGPUs = 2032; // Fixed value
            const totalNodes = 254; // Fixed value
            
            document.getElementById('totalDevices').textContent = totalNodes;
            document.getElementById('totalGPUs').textContent = totalGPUs;
            
            // Debug: Log what we're setting
            console.log('Setting totalDevices to:', totalNodes);
            console.log('Setting totalGPUs to:', totalGPUs);
            console.log('API results summary:', results.summary);
            console.log('Total throttled from API:', results.summary?.throttled_count);
            
            // Calculate throttle rate: final throttled count vs total GPUs in the system
            const throttleRate = totalGPUs > 0 ? ((finalThrottledCount / totalGPUs) * 100).toFixed(2) : '0.00';
            document.getElementById('throttleRate').textContent = throttleRate + '%';
            
            // Log the throttle rate calculation
            console.log('Throttle rate calculation:', finalThrottledCount, '/', totalGPUs, '=', throttleRate + '%');
            
                    // Update each GPU status box
        GPU_IDS.forEach(gpuId => {
            const count = gpuCounts[gpuId] || 0;
            // Calculate percentage: unique events for this GPU ID / total unique events
            const percentage = totalThrottled > 0 ? ((count / totalThrottled) * 100).toFixed(1) : 0;
            
            // Update count and percentage
            document.getElementById(`count-${gpuId}`).textContent = count;
            document.getElementById(`percent-${gpuId}`).textContent = percentage + '%';
            
            // Update status box color based on percentage using dynamic gradient
            const statusBox = document.getElementById(`gpu-${gpuId}`);
            statusBox.className = 'gpu-status-box';
            
            // Remove old color classes
            statusBox.classList.remove('low', 'medium', 'high');
            
            if (count === 0) {
                // Dark Green for 0% (no throttling)
                statusBox.style.background = 'linear-gradient(135deg, #008000 0%, #008000 100%)';
            } else {
                // Dynamic gradient using your hex color codes
                const percentValue = parseFloat(percentage);
                let color;
                
                if (percentValue === 0) {
                    // 0%: Dark Green
                    color = '#008000';
                } else if (percentValue <= 3) {
                    // 1-3%: Lime Green
                    color = '#c0e000';
                } else if (percentValue <= 7) {
                    // 3-7%: Yellow
                    color = '#ffd100';
                } else if (percentValue <= 10) {
                    // 7-10%: Orange
                    color = '#ff7a00';
                } else if (percentValue <= 15) {
                    // 10-15%: Darker Orange
                    color = '#FF8C00';
                } else {
                    // >15%: Red
                    color = '#ff0000';
                }
                
                statusBox.style.background = `linear-gradient(135deg, ${color} 0%, ${darkenColor(color, 20)} 100%)`;
            }
        });
        }
        
        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = `Last updated: ${now.toLocaleString()}`;
        }
        
        // Helper function to interpolate between two hex colors
        function interpolateColor(color1, color2, factor) {
            const r1 = parseInt(color1.slice(1, 3), 16);
            const g1 = parseInt(color1.slice(3, 5), 16);
            const b1 = parseInt(color1.slice(5, 7), 16);
            
            const r2 = parseInt(color2.slice(1, 3), 16);
            const g2 = parseInt(color2.slice(3, 5), 16);
            const b2 = parseInt(color2.slice(5, 7), 16);
            
            const r = Math.round(r1 + (r2 - r1) * factor);
            const g = Math.round(g1 + (g2 - g1) * factor);
            const b = Math.round(b1 + (b2 - b1) * factor);
            
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }
        
        // Helper function to darken a hex color
        function darkenColor(color, percent) {
            const r = parseInt(color.slice(1, 3), 16);
            const g = parseInt(color.slice(3, 5), 16);
            const b = parseInt(color.slice(5, 7), 16);
            
            const factor = 1 - (percent / 100);
            const newR = Math.round(r * factor);
            const newG = Math.round(g * factor);
            const newB = Math.round(b * factor);
            
            return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeAnalytics);
    </script>
</body>
</html>
